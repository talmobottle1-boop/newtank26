<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>익명 대나무숲 게시판</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap');
        body { font-family: 'Pretendard', sans-serif; }
        .post-card { transition: all 0.2s ease-in-out; }
        .post-card:hover { border-color: #6366f1; transform: translateY(-2px); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 sticky top-0 z-20">
        <div class="max-w-2xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <div class="bg-indigo-600 p-2 rounded-lg text-white">
                    <i class="fas fa-comment-dots"></i>
                </div>
                <h1 class="text-xl font-extrabold tracking-tight">대나무숲</h1>
            </div>
            <div id="status-badge" class="flex items-center gap-2 bg-gray-100 px-3 py-1.5 rounded-full">
                <div class="w-2 h-2 rounded-full bg-gray-400"></div>
                <span class="text-xs font-bold text-gray-600 uppercase">연결 중...</span>
            </div>
        </div>
    </header>

    <main class="max-w-2xl mx-auto px-4 py-8">
        <!-- Input Section -->
        <div class="bg-white rounded-2xl shadow-sm border border-gray-200 p-5 mb-8">
            <div class="flex gap-4">
                <div id="my-avatar" class="w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center text-white bg-gray-200">
                    <i class="fas fa-user"></i>
                </div>
                <div class="flex-1">
                    <textarea id="post-input" placeholder="지금 무슨 생각을 하고 계신가요?" 
                        class="w-full text-lg bg-transparent border-none focus:ring-0 placeholder-gray-400 resize-none min-h-[100px] py-2 focus:outline-none"></textarea>
                    <div class="mt-4 pt-4 border-t border-gray-100 flex justify-end">
                        <button id="submit-btn" disabled
                            class="bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50 text-white px-6 py-2 rounded-full font-bold transition-all flex items-center gap-2 shadow-md shadow-indigo-100">
                            <i class="fas fa-paper-plane"></i>
                            게시
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Posts List -->
        <div id="posts-container" class="space-y-6">
            <div class="text-center py-20">
                <i class="fas fa-ghost text-gray-200 text-5xl mb-3 block"></i>
                <p class="text-gray-400">게시물을 불러오고 있습니다...</p>
            </div>
        </div>
    </main>

    <footer class="max-w-2xl mx-auto px-4 pb-12 text-center text-gray-400 text-xs">
        모든 글은 익명으로 실시간 기록됩니다.
    </footer>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase 설정 (환경 변수로부터 로드)
        const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'github-anon-board';

        let currentUser = null;

        // UI 요소
        const postInput = document.getElementById('post-input');
        const submitBtn = document.getElementById('submit-btn');
        const postsContainer = document.getElementById('posts-container');
        const statusBadge = document.getElementById('status-badge');
        const myAvatar = document.getElementById('my-avatar');

        // 랜덤 색상 함수
        const getUserColor = (uid) => {
            const colors = ['bg-red-400', 'bg-blue-400', 'bg-green-400', 'bg-yellow-400', 'bg-purple-400', 'bg-pink-400', 'bg-indigo-400', 'bg-teal-400'];
            let hash = 0;
            for (let i = 0; i < uid.length; i++) hash = uid.charCodeAt(i) + ((hash << 5) - hash);
            return colors[Math.abs(hash) % colors.length];
        };

        // 익명 로그인
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                statusBadge.innerHTML = `<div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div><span class="text-xs font-bold text-gray-600 uppercase">익명 접속 중</span>`;
                myAvatar.className = `w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center text-white ${getUserColor(user.uid)}`;
                submitBtn.disabled = false;
                loadPosts();
            } else {
                signInAnonymously(auth).catch(console.error);
            }
        });

        // 글쓰기 기능
        submitBtn.onclick = async () => {
            const content = postInput.value.trim();
            if (!content || !currentUser) return;

            submitBtn.disabled = true;
            try {
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'posts'), {
                    content: content,
                    userId: currentUser.uid,
                    createdAt: serverTimestamp()
                });
                postInput.value = '';
            } catch (e) {
                console.error("Error adding document: ", e);
            } finally {
                submitBtn.disabled = false;
            }
        };

        // 실시간 게시글 로드
        function loadPosts() {
            const postsRef = collection(db, 'artifacts', appId, 'public', 'data', 'posts');
            onSnapshot(postsRef, (snapshot) => {
                const postsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                // 서버 타임스탬프 기준으로 정렬 (메모리에서 처리)
                postsData.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                
                renderPosts(postsData);
            });
        }

        // 게시글 렌더링
        function renderPosts(posts) {
            if (posts.length === 0) {
                postsContainer.innerHTML = `<div class="text-center py-20 bg-white rounded-2xl border border-dashed border-gray-300">
                    <i class="fas fa-ghost text-gray-200 text-5xl mb-3 block"></i>
                    <p class="text-gray-400">아직 아무도 이야기를 시작하지 않았습니다.</p>
                </div>`;
                return;
            }

            postsContainer.innerHTML = posts.map(post => {
                const time = post.createdAt ? new Date(post.createdAt.seconds * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '방금 전';
                const userColor = getUserColor(post.userId);
                return `
                <article class="post-card bg-white rounded-2xl border border-gray-200 p-6">
                    <div class="flex gap-4">
                        <div class="w-10 h-10 rounded-full flex-shrink-0 flex items-center justify-center text-white ${userColor}">
                            <i class="fas fa-user text-sm"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-bold text-gray-900 text-sm sm:text-base">익명 사용자</span>
                                <span class="text-gray-400 text-xs">·</span>
                                <span class="text-gray-400 text-xs">${time}</span>
                            </div>
                            <p class="text-gray-800 text-base sm:text-lg leading-relaxed whitespace-pre-wrap break-words">${escapeHtml(post.content)}</p>
                            <div class="mt-4 flex items-center gap-1 text-gray-300">
                                <i class="fas fa-hashtag text-[10px]"></i>
                                <span class="text-[10px] font-mono tracking-tighter">${post.userId.substring(0, 10)}</span>
                            </div>
                        </div>
                    </div>
                </article>
                `;
            }).join('');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>

