<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEWTANK26 - Real-time Leaderboard</title>
    <style>
        :root {
            --db-blue: #00d2ff;
            --db-bg: #050a15;
            --db-panel: rgba(10, 25, 50, 0.9);
            --db-border: rgba(0, 210, 255, 0.3);
            --accent: #9d50bb;
        }
        body {
            background-color: var(--db-bg);
            color: #fff;
            font-family: 'Segoe UI', sans-serif;
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
            min-height: 100vh;
        }
        .db-status-card {
            width: 100%; max-width: 900px;
            background: var(--db-panel);
            border: 1px solid var(--db-border);
            border-radius: 12px; padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            margin-top: 40px;
        }
        .header {
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--db-border);
            padding-bottom: 15px; margin-bottom: 20px;
        }
        .status-indicator {
            display: flex; align-items: center; gap: 8px; font-size: 14px;
        }
        .dot { width: 10px; height: 10px; border-radius: 50%; background: #555; }
        .dot.active { background: #00ff88; box-shadow: 0 0 10px #00ff88; }
        .dot.error { background: #ff4444; box-shadow: 0 0 10px #ff4444; }
        
        .ranking-table-container {
            max-height: 650px;
            overflow-y: auto;
            margin-top: 10px;
        }
        .ranking-table {
            width: 100%; border-collapse: collapse;
        }
        .ranking-table th {
            position: sticky; top: 0; background: #0a1932;
            text-align: left; padding: 12px; font-size: 12px; color: var(--db-blue);
            text-transform: uppercase; border-bottom: 2px solid var(--db-border);
            z-index: 10;
        }
        .ranking-table td {
            padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 14px;
        }
        .my-row { background: rgba(0, 210, 255, 0.1); border-left: 3px solid var(--db-blue); }
        
        .error-box {
            display: none;
            background: rgba(255, 68, 68, 0.1);
            border: 1px solid #ff4444;
            color: #ff4444;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 13px;
        }

        .refresh-notice {
            margin-top: 25px;
            font-size: 12px;
            color: #557799;
            text-align: center;
        }
    </style>
</head>
<body>

    <div class="db-status-card">
        <div id="error-message" class="error-box"></div>

        <div class="header">
            <h2 style="margin:0; color: #fff; letter-spacing: 1px;">GLOBAL LEADERBOARD</h2>
            <div class="status-indicator">
                <div id="status-dot" class="dot"></div>
                <span id="status-text">서버 연결 중...</span>
            </div>
        </div>

        <div class="ranking-table-container">
            <table class="ranking-table">
                <thead>
                    <tr>
                        <th>순위</th>
                        <th>파일럿 ID</th>
                        <th>닉네임</th>
                        <th>총 점수</th>
                        <th>최근 활동</th>
                    </tr>
                </thead>
                <tbody id="db-ranking-body">
                    <tr><td colspan="5" style="text-align:center; padding: 80px; color: #557799;">실시간 데이터를 동기화하고 있습니다...</td></tr>
                </tbody>
            </table>
        </div>
        
        <div class="refresh-notice">
            본 랭킹은 실시간으로 업데이트되며 상위 100명의 파일럿 정보가 표시됩니다.
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase 설정 로드
        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let leaderboardUnsubscribe = null;

        function showError(msg) {
            const errBox = document.getElementById('error-message');
            errBox.style.display = 'block';
            errBox.innerText = "⚠️ 시스템 오류: " + msg;
            document.getElementById('status-dot').className = 'dot error';
            document.getElementById('status-text').innerText = "연결 끊김";
        }

        const initAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (err) {
                console.error("Auth Error:", err);
                showError("인증에 실패했습니다. 네트워크 상태를 확인하세요.");
            }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                document.getElementById('status-dot').className = 'dot active';
                document.getElementById('status-text').innerText = "데이터베이스 온라인";
                if (leaderboardUnsubscribe) leaderboardUnsubscribe();
                loadLeaderboard(user);
            }
        });

        function loadLeaderboard(user) {
            if (!user) return;
            const leaderboardRef = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
            
            // 모든 데이터를 실시간 감시 (Rule 2 준수: 클라이언트 사이드 정렬)
            const q = query(leaderboardRef);

            leaderboardUnsubscribe = onSnapshot(q, (snapshot) => {
                const players = [];
                snapshot.forEach(doc => {
                    players.push({ id: doc.id, ...doc.data() });
                });
                
                // 점수 기준 내림차순 정렬
                players.sort((a, b) => (b.score || 0) - (a.score || 0));
                renderUI(players);
            }, (error) => {
                console.error("Firestore Error:", error);
                showError("데이터 로드 권한이 없습니다.");
            });
        }

        function renderUI(players) {
            const body = document.getElementById('db-ranking-body');
            body.innerHTML = '';
            
            if (players.length === 0) {
                body.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 80px; color: #557799;">현재 등록된 파일럿 데이터가 없습니다.</td></tr>';
                return;
            }

            // 상위 100명 표시
            players.slice(0, 100).forEach((p, index) => {
                const isMe = auth.currentUser && p.id === auth.currentUser.uid;
                const row = document.createElement('tr');
                if (isMe) row.className = 'my-row';
                
                const time = p.lastUpdated ? new Date(p.lastUpdated).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '-';

                row.innerHTML = `
                    <td>#${index + 1}</td>
                    <td style="font-family: monospace; font-size: 11px; color: #88aacc;">${p.id.substring(0, 8)}</td>
                    <td><strong style="color: ${isMe ? '#00d2ff' : '#fff'}">${p.nickname || 'Unknown'}</strong></td>
                    <td style="color: var(--db-blue); font-weight: bold;">${(p.score || 0).toLocaleString()}</td>
                    <td style="font-size: 11px; opacity: 0.6;">${time}</td>
                `;
                body.appendChild(row);
            });
        }

        initAuth();
    </script>
</body>
</html>
