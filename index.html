<<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>OXBIT | Professional Crypto DEX</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <!-- React & ReactDOM CDN -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            -webkit-tap-highlight-color: transparent;
        }
        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #e2e8f0; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #334155; }
        
        .transition-all { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }

        .chart-container {
            position: relative;
            width: 100%;
            padding-top: 45%; 
        }
        @media (max-width: 768px) {
            .chart-container { padding-top: 85%; }
        }

        /* Chart Overlay Styles */
        .price-line {
            position: absolute;
            left: 0;
            right: 0;
            pointer-events: none;
            display: flex;
            align-items: center;
            z-index: 10;
        }
        .price-label {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 800;
            color: white;
            white-space: nowrap;
            margin-left: auto;
            margin-right: 60px; /* Aligned with TV price scale */
        }
    </style>
</head>
<body class="text-slate-800 dark:text-slate-200 antialiased overflow-x-hidden bg-slate-50 dark:bg-slate-950 transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { 
            Wallet, Settings, TrendingUp, BarChart3, Share2, Info, MoreHorizontal, X, ArrowDown, ArrowUp, Sun, Moon, TrendingDown
        } = lucide;

        const OPEN_SOUND = "https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3";
        const CLOSE_SOUND = "https://assets.mixkit.co/active_storage/sfx/2568/2568-preview.mp3";

        const App = () => {
            const [leverage, setLeverage] = useState(10);
            const [isWalletConnected, setIsWalletConnected] = useState(false);
            const [activeTab, setActiveTab] = useState('long');
            const [btcPrice, setBtcPrice] = useState(0);
            const [priceChange, setPriceChange] = useState(0);
            const [high24h, setHigh24h] = useState(0);
            const [low24h, setLow24h] = useState(0);
            const [volume24h, setVolume24h] = useState(0);
            const [showPnlCard, setShowPnlCard] = useState(null); 
            const [mobileNav, setMobileNav] = useState('trade');
            const [isDark, setIsDark] = useState(false);
            const [orderAmount, setOrderAmount] = useState('');
            const [positions, setPositions] = useState([]);

            const openAudio = useRef(new Audio(OPEN_SOUND));
            const closeAudio = useRef(new Audio(CLOSE_SOUND));

            useEffect(() => {
                if (isDark) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }, [isDark]);

            useEffect(() => {
                let ws;
                const connectWS = () => {
                    ws = new WebSocket('wss://stream.binance.com:9443/ws/btcusdt@ticker');
                    ws.onmessage = (event) => {
                        const data = JSON.parse(event.data);
                        setBtcPrice(parseFloat(data.c));
                        setPriceChange(parseFloat(data.P));
                        setHigh24h(parseFloat(data.h));
                        setLow24h(parseFloat(data.l));
                        setVolume24h(parseFloat(data.q));
                    };
                    ws.onclose = () => setTimeout(connectWS, 3000);
                };
                connectWS();
                return () => ws && ws.close();
            }, []);

            useEffect(() => {
                const timer = setTimeout(() => {
                    if (typeof lucide !== 'undefined') lucide.createIcons();
                }, 100);
                return () => clearTimeout(timer);
            }, [btcPrice, showPnlCard, mobileNav, isDark, positions]);

            const playSound = (type) => {
                try {
                    const audio = type === 'open' ? openAudio.current : closeAudio.current;
                    audio.currentTime = 0;
                    audio.play().catch(() => {});
                } catch (e) {}
            };

            const getLivePnL = (pos) => {
                const diff = btcPrice - pos.entryPrice;
                const uPnl = pos.side === 'long' ? diff * pos.size : -diff * pos.size;
                const roe = (uPnl / pos.amount) * 100;
                const liqPrice = pos.side === 'long' 
                    ? pos.entryPrice * (1 - 1/pos.leverage)
                    : pos.entryPrice * (1 + 1/pos.leverage);
                return { uPnl, roe, liqPrice };
            };

            const openPosition = () => {
                const amount = parseFloat(orderAmount);
                if (!amount || amount <= 0) return;
                const newPosition = {
                    id: Date.now(),
                    symbol: 'BTC/USDT',
                    side: activeTab,
                    leverage: leverage,
                    entryPrice: btcPrice,
                    amount: amount,
                    size: (amount * leverage) / btcPrice,
                    timestamp: new Date()
                };
                setPositions([newPosition, ...positions]);
                setOrderAmount('');
                playSound('open');
            };

            const closePosition = (id) => {
                setPositions(positions.filter(p => p.id !== id));
                playSound('close');
            };

            const orderBookData = useMemo(() => {
                if (btcPrice === 0) return { asks: [], bids: [] };
                const asks = [], bids = [];
                for (let i = 5; i >= 1; i--) asks.push({ price: btcPrice + (i * 0.5), amount: (Math.random() * 0.5 + 0.1).toFixed(3) });
                for (let i = 1; i <= 5; i++) bids.push({ price: btcPrice - (i * 0.5), amount: (Math.random() * 0.8 + 0.2).toFixed(3) });
                return { asks, bids };
            }, [btcPrice]);

            // Helper to calculate overlay Y position
            const getPriceY = (targetPrice) => {
                if (!btcPrice) return '50%';
                // Simple visualization logic: Map +/- 2% price range to container height
                const range = btcPrice * 0.02; 
                const diff = targetPrice - btcPrice;
                const percent = 50 - (diff / range) * 50;
                return Math.max(5, Math.min(95, percent)) + '%';
            };

            const OxbitLogo = ({ small = false }) => (
                <div className="flex items-center gap-2">
                    <div className={`${small ? 'p-1' : 'p-1.5'} bg-sky-500 rounded-lg shadow-md`}>
                        <div className="grid grid-cols-3 gap-0.5">
                            {[...Array(9)].map((_, i) => (
                                <div key={i} className={`${small ? 'w-1 h-1' : 'w-1.5 h-1.5'} rounded-full ${i === 4 ? 'bg-white' : 'bg-white opacity-40'}`}></div>
                            ))}
                        </div>
                    </div>
                    {!small && (
                        <span className="text-lg font-black tracking-tighter text-slate-900 dark:text-white">
                            OX<span className="text-sky-500">BIT</span>
                        </span>
                    )}
                </div>
            );

            if (btcPrice === 0) return <div className="min-h-screen flex items-center justify-center dark:bg-slate-950"><div className="w-10 h-10 border-4 border-sky-500/20 border-t-sky-500 rounded-full animate-spin"></div></div>;

            return (
                <div className="min-h-screen bg-slate-50 dark:bg-slate-950 flex flex-col transition-colors duration-300">
                    {/* Header */}
                    <header className="sticky top-0 z-50 bg-white/90 dark:bg-slate-900/90 backdrop-blur-md border-b border-slate-100 dark:border-slate-800 px-4 md:px-8 h-14 flex justify-between items-center">
                        <div className="flex items-center gap-8">
                            <OxbitLogo />
                        </div>
                        <div className="flex items-center gap-2">
                            <button onClick={() => setIsDark(!isDark)} className="p-2.5 rounded-xl bg-slate-50 dark:bg-slate-800 text-slate-500 dark:text-slate-400 border border-slate-100 dark:border-slate-700">
                                {isDark ? <i data-lucide="sun" className="w-4 h-4"></i> : <i data-lucide="moon" className="w-4 h-4"></i>}
                            </button>
                            <button onClick={() => setIsWalletConnected(!isWalletConnected)} className={`px-4 py-2 rounded-xl font-bold text-[11px] ${isWalletConnected ? 'bg-sky-50 dark:bg-sky-500/10 text-sky-600 border border-sky-100 dark:border-sky-500/20' : 'bg-sky-500 text-white'}`}>
                                {isWalletConnected ? '0x71...4f2' : '지갑 연결'}
                            </button>
                        </div>
                    </header>

                    {/* Main */}
                    <main className="flex-1 max-w-[1600px] mx-auto w-full p-2 md:p-4 grid grid-cols-12 gap-3 md:gap-4 pb-20">
                        
                        <div className={`col-span-12 lg:col-span-9 space-y-4 ${mobileNav !== 'trade' ? 'hidden md:block' : ''}`}>
                            {/* Chart Container with Position Overlay */}
                            <div className="bg-white dark:bg-slate-900 rounded-2xl border border-slate-100 dark:border-slate-800 overflow-hidden shadow-sm relative chart-container">
                                <iframe id="tv" title="TradingView" src={`https://www.tradingview.com/widgetembed/?symbol=BINANCE:BTCUSDT&interval=1&theme=${isDark ? 'dark' : 'light'}&style=1&timezone=Asia%2FSeoul&locale=kr`} width="100%" height="100%" frameBorder="0" className="absolute inset-0"></iframe>
                                
                                {/* Position Overlays */}
                                {positions.map(pos => {
                                    const { liqPrice } = getLivePnL(pos);
                                    return (
                                        <React.Fragment key={pos.id}>
                                            {/* Entry Line */}
                                            <div className="price-line" style={{ top: getPriceY(pos.entryPrice) }}>
                                                <div className={`h-[1px] flex-1 border-t border-dashed ${pos.side === 'long' ? 'border-sky-500' : 'border-orange-500'}`}></div>
                                                <div className={`price-label ${pos.side === 'long' ? 'bg-sky-500' : 'bg-orange-500'}`}>
                                                    {pos.side.toUpperCase()} ENTRY: ${pos.entryPrice.toLocaleString()}
                                                </div>
                                            </div>
                                            {/* Liquidation Line */}
                                            <div className="price-line" style={{ top: getPriceY(liqPrice) }}>
                                                <div className="h-[2px] flex-1 bg-rose-500 opacity-40"></div>
                                                <div className="price-label bg-rose-600">
                                                    LIQ PRICE: ${liqPrice.toLocaleString(undefined, { maximumFractionDigits: 1 })}
                                                </div>
                                            </div>
                                        </React.Fragment>
                                    );
                                })}
                            </div>

                            {/* Position Table */}
                            <div className="bg-white dark:bg-slate-900 rounded-2xl border border-slate-100 dark:border-slate-800 overflow-hidden shadow-sm">
                                <div className="px-5 py-4 border-b border-slate-50 dark:border-slate-800">
                                    <span className="text-[11px] font-black text-sky-500">오픈 포지션 ({positions.length})</span>
                                </div>
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left text-[11px]">
                                        <thead className="text-slate-400 dark:text-slate-500 uppercase font-bold border-b border-slate-50 dark:border-slate-800">
                                            <tr>
                                                <th className="px-5 py-3 text-[10px]">자산</th>
                                                <th className="px-5 py-3 text-right">수량</th>
                                                <th className="px-5 py-3 text-right">진입가</th>
                                                <th className="px-5 py-3 text-right">청산가</th>
                                                <th className="px-5 py-3 text-right">미실현 손익</th>
                                                <th className="px-5 py-3 text-center">액션</th>
                                            </tr>
                                        </thead>
                                        <tbody className="font-semibold">
                                            {positions.map(pos => {
                                                const { uPnl, roe, liqPrice } = getLivePnL(pos);
                                                return (
                                                    <tr key={pos.id} className="border-b border-slate-50 dark:border-slate-800 last:border-0 hover:bg-slate-50 dark:hover:bg-slate-800/50">
                                                        <td className="px-5 py-4">
                                                            <div className="flex flex-col">
                                                                <span className={pos.side === 'long' ? 'text-emerald-500' : 'text-rose-500'}>BTC {pos.side.toUpperCase()}</span>
                                                                <span className="text-[9px] text-slate-400">{pos.leverage}x Cross</span>
                                                            </div>
                                                        </td>
                                                        <td className="px-5 py-4 text-right font-mono">{pos.size.toFixed(4)}</td>
                                                        <td className="px-5 py-4 text-right font-mono text-slate-400">${pos.entryPrice.toLocaleString()}</td>
                                                        <td className="px-5 py-4 text-right font-mono text-rose-400">${liqPrice.toLocaleString(undefined, { maximumFractionDigits: 1 })}</td>
                                                        <td className="px-5 py-4 text-right">
                                                            <div className={`flex flex-col ${uPnl >= 0 ? 'text-emerald-500' : 'text-rose-500'}`}>
                                                                <span>{uPnl >= 0 ? '+' : ''}{uPnl.toFixed(2)} USDT</span>
                                                                <span className="text-[9px]">{roe.toFixed(2)}%</span>
                                                            </div>
                                                        </td>
                                                        <td className="px-5 py-4 text-center">
                                                            <button onClick={() => closePosition(pos.id)} className="px-3 py-1 bg-rose-500/10 text-rose-500 rounded-lg hover:bg-rose-500 hover:text-white transition-all">종료</button>
                                                        </td>
                                                    </tr>
                                                );
                                            })}
                                            {positions.length === 0 && <tr><td colSpan="6" className="py-12 text-center text-slate-300 font-bold">활성화된 포지션이 없습니다</td></tr>}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        {/* Order & Trade Panel */}
                        <div className={`col-span-12 lg:col-span-3 space-y-4 ${mobileNav === 'trade' ? 'hidden md:block' : ''}`}>
                            <div className="bg-white dark:bg-slate-900 rounded-2xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm">
                                <div className="flex bg-slate-50 dark:bg-slate-800 p-1 rounded-xl mb-6">
                                    <button onClick={() => setActiveTab('long')} className={`flex-1 py-2 rounded-lg font-bold text-[11px] ${activeTab === 'long' ? 'bg-sky-500 text-white shadow-md' : 'text-slate-400'}`}>Long</button>
                                    <button onClick={() => setActiveTab('short')} className={`flex-1 py-2 rounded-lg font-bold text-[11px] ${activeTab === 'short' ? 'bg-rose-500 text-white shadow-md' : 'text-slate-400'}`}>Short</button>
                                </div>
                                <div className="space-y-4">
                                    <div>
                                        <div className="flex justify-between text-[10px] font-bold mb-2 uppercase text-slate-400">Leverage <span className="text-sky-500">{leverage}x</span></div>
                                        <input type="range" min="1" max="100" value={leverage} onChange={(e) => setLeverage(Number(e.target.value))} className="w-full h-1 bg-slate-100 dark:bg-slate-800 rounded-full appearance-none cursor-pointer" />
                                    </div>
                                    <div className="bg-slate-50 dark:bg-slate-800 rounded-xl p-3 border border-slate-100 dark:border-slate-700">
                                        <div className="text-[9px] font-bold text-slate-400 uppercase mb-1">Amount (USDT)</div>
                                        <input type="number" value={orderAmount} onChange={(e) => setOrderAmount(e.target.value)} placeholder="0.00" className="bg-transparent text-lg font-bold outline-none w-full dark:text-white" />
                                    </div>
                                    <button onClick={openPosition} className={`w-full py-4 ${activeTab === 'long' ? 'bg-sky-500' : 'bg-rose-500'} text-white rounded-xl font-bold text-xs shadow-lg active:scale-95 transition-all`}>포지션 오픈</button>
                                </div>
                            </div>

                            <div className="bg-white dark:bg-slate-900 rounded-2xl p-4 border border-slate-100 dark:border-slate-800 shadow-sm">
                                <h3 className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-4">Order Book</h3>
                                <div className="space-y-0.5 font-mono text-[10px] font-bold">
                                    {orderBookData.asks.map((item, i) => (
                                        <div key={`a-${i}`} className="flex justify-between py-0.5"><span className="text-rose-400">${item.price.toLocaleString(undefined, { minimumFractionDigits: 1 })}</span><span className="text-slate-300">{item.amount}</span></div>
                                    ))}
                                    <div className="py-2 my-2 text-center text-sky-500 bg-sky-50 dark:bg-sky-500/10 rounded-lg font-bold">${btcPrice.toLocaleString(undefined, { minimumFractionDigits: 1 })}</div>
                                    {orderBookData.bids.map((item, i) => (
                                        <div key={`b-${i}`} className="flex justify-between py-0.5"><span className="text-emerald-500">${item.price.toLocaleString(undefined, { minimumFractionDigits: 1 })}</span><span className="text-slate-300">{item.amount}</span></div>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </main>

                    {/* Mobile Nav */}
                    <nav className="md:hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-slate-900 border-t border-slate-100 dark:border-slate-800 grid grid-cols-4 py-3 z-50">
                        <button onClick={() => setMobileNav('trade')} className={`flex flex-col items-center ${mobileNav === 'trade' ? 'text-sky-500' : 'text-slate-300'}`}><i data-lucide="trending-up" className="w-5 h-5"></i><span className="text-[9px] font-bold">Trade</span></button>
                        <button onClick={() => setMobileNav('info')} className={`flex flex-col items-center ${mobileNav === 'info' ? 'text-sky-500' : 'text-slate-300'}`}><i data-lucide="bar-chart-3" className="w-5 h-5"></i><span className="text-[9px] font-bold">Market</span></button>
                        <button className="flex flex-col items-center text-slate-300"><i data-lucide="wallet" className="w-5 h-5"></i><span className="text-[9px] font-bold">Assets</span></button>
                        <button className="flex flex-col items-center text-slate-300"><i data-lucide="settings" className="w-5 h-5"></i><span className="text-[9px] font-bold">More</span></button>
                    </nav>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
